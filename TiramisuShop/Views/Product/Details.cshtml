@model TiramisuShop.Models.Product
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Name;
    var relatedProducts = ViewBag.RelatedProducts as List<TiramisuShop.Models.Product>;

    var mainColor = !string.IsNullOrEmpty(Model.HexColor) ? Model.HexColor : "#4B3022";

    // --- LOGIC TÍNH GIÁ MỚI ---
    decimal originalPrice = Model.Price;
    decimal finalPrice = Model.Price;
    bool isSale = false;
    double discountPercent = 0;
    var now = DateTime.Now;

    if (Model.EventId != null && Model.Event != null && now >= Model.Event.StartDate && now <= Model.Event.EndDate)
    {
        isSale = true;
        discountPercent = Model.Event.DiscountPercent;
        finalPrice = originalPrice * (decimal)((100 - discountPercent) / 100);
    }
    // ---------------------------

    double avgRating = ViewBag.AverageRating ?? 0;
    int reviewCount = ViewBag.ReviewCount ?? 0;
    int roundedRating = (int)Math.Round(avgRating);
}

@section Links {
    <link rel="stylesheet" href="~/css/product-index.css">
    <link rel="stylesheet" href="~/css/product-details.css">
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Kanit:wght@300;400;500;600&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .form-title {
            font-family: 'Pacifico';
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: @mainColor;
        }

        .btn-submit-review {
            background-color: @mainColor;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
    </style>
}

<section id="content" style="background: #FCF5EF;">

    <div id="intro-picture">
        <div class="swiper mySwiper introSwiper">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><img src="~/assets/images/Home.png" alt="Cheese Cheese Banner"></div>
            </div>
        </div>
        <h2 class="title-cheese">CHEESE CHEESE</h2>
        <h5 class="subtitle-cheese">Thực đơn ngọt ngào</h5>
    </div>

    <div class="breadcrumb-area">
        <div class="container">
            <div class="breadcrumb-content">
                <a href="/">Trang chủ</a> <span class="divider">/</span>
                <a href="/Product">Thực đơn</a> <span class="divider">/</span>
                <span class="current" style="color: @mainColor">@Model.Name</span>
            </div>
        </div>
    </div>

    <div class="product-detail-section">
        <div class="container">
            <div class="row-detail">

                <div class="col-gallery">
                    <div style="--theme-color: @mainColor" class="swiper gallery-main">
                        <div class="swiper-wrapper">
                            @if (Model.ProductImages != null && Model.ProductImages.Count > 0)
                            {
                                foreach (var img in Model.ProductImages)
                                {
                                    <div class="swiper-slide"><img src="@img.ImageUrl" alt="@Model.Name" /></div>
                                }
                            }
                            else
                            {
                                <div class="swiper-slide"><img src="/assets/images/no-image.png" alt="No Image" /></div>
                            }
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                    <div class="swiper gallery-thumbs">
                        <div class="swiper-wrapper">
                            @if (Model.ProductImages != null)
                            {
                                foreach (var img in Model.ProductImages)
                                {
                                    <div class="swiper-slide"><img src="@img.ImageUrl" alt="Thumbnail" /></div>
                                }
                            }
                        </div>
                    </div>
                </div>

                <div class="col-info fade-up">
                    <div class="badges-wrapper">
                        @if (Model.Stock <= 0)
                        {
                            <span class="badge" style="background: #7f8c8d; color: white;">Hết hàng</span>
                        }
                        else if (isSale)
                        {
                            <span class="badge sale" style="background: #ff6b81;">-@discountPercent%</span>
                        }

                        @if (Model.IsHot)
                        {
                            <span class="badge hot">Best Seller</span>
                        }
                    </div>

                    <h1 class="p-name" style="color: @mainColor">@Model.Name</h1>

                    <div class="p-rating">
                    </div>

                    <div class="p-price">
                        @if (isSale)
                        {
                            <span class="current-price" style="color: @mainColor">@finalPrice.ToString("N0") đ</span>

                            <span class="old-price" style="text-decoration: line-through; color: #999; font-size: 1.2rem; font-weight: 400;">
                                @originalPrice.ToString("N0") đ
                            </span>
                        }
                        else
                        {
                            <span class="current-price" style="color: @mainColor">@originalPrice.ToString("N0") đ</span>
                        }
                    </div>

                    <div class="p-desc">
                        <p>@Model.Description</p>
                        <ul class="p-features">
                            <li><i class="fa-solid fa-check" style="color: @mainColor"></i> 100% Nguyên liệu tự nhiên</li>
                            <li><i class="fa-solid fa-check" style="color: @mainColor"></i> Không chất bảo quản</li>
                        </ul>
                    </div>

                    <div class="p-form">
                        <input type="hidden" id="productId" value="@Model.Id" />

                        <div class="quantity-control">
                            <button type="button" class="qty-btn minus"><i class="fa-solid fa-minus"></i></button>
                            <input type="number" id="quantity" value="1" min="1" max="@Model.Stock" class="qty-input" readonly>
                            <button type="button" class="qty-btn plus"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        @if (Model.Stock > 0)
                        {
                            <button type="button" id="btnAddToCart" class="btn-add-to-cart" style="background-color: @mainColor">
                                <i class="fa-solid fa-cart-shopping"></i> Thêm vào giỏ
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn-add-to-cart disabled" disabled style="background-color: #ccc; cursor: not-allowed;">
                                <i class="fa-solid fa-ban"></i> Tạm hết hàng
                            </button>
                        }
                    </div>

                    <div class="p-meta">
                        <span><strong>Danh mục:</strong> @Model.Category.Name</span>
                        <span><strong>Tình trạng:</strong> @(Model.Stock > 0 ? "Còn hàng" : "Hết hàng")</span>
                    </div>
                </div>
            </div>

            <div class="product-tabs fade-up delay-2">
                <div class="tabs-header">
                    <button class="tab-link active" onclick="openTab(event, 'desc')">Mô tả chi tiết</button>
                    <button class="tab-link" onclick="openTab(event, 'reviews')">Đánh giá (@reviewCount)</button>
                    <button class="tab-link" onclick="openTab(event, 'shipping')">Chính sách giao hàng</button>
                </div>

                <div class="tabs-content">
                    <div id="desc" class="tab-pane active">
                        <p>@Model.Description. Thưởng thức hương vị tuyệt vời được tạo nên từ sự đam mê và tỉ mỉ của những người thợ làm bánh tại Cheese Cheese.</p>
                    </div>

                    <div id="reviews" class="tab-pane">

                        <div class="review-list">
                            @if (Model.Reviews != null && Model.Reviews.Any())
                            {
                                foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
                                {
                                    <div class="review-item">
                                        <div class="review-avatar">
                                            @review.User.FirstName?.Substring(0, 1)
                                        </div>
                                        <div class="review-content">
                                            <div class="r-header">
                                                <span class="r-name">@review.User.FirstName @review.User.LastName</span>
                                                <span class="r-date">@review.CreatedAt.ToString("dd/MM/yyyy")</span>
                                            </div>
                                            <div class="r-stars">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    if (i <= review.Rating)
                                                    {
                                                        <i class="fa-solid fa-star"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-regular fa-star" style="color: #ddd;"></i>
                                                    }
                                                }
                                            </div>
                                            <p class="r-comment">@review.Comment</p>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <p style="font-style: italic; color: #888;">Chưa có đánh giá nào. Hãy là người đầu tiên!</p>
                            }
                        </div>

                        <div class="review-form-box">
                            <h3 class="form-title">Viết đánh giá của bạn</h3>
                            @if (User.Identity.IsAuthenticated)
                            {
                                <form id="reviewForm">
                                    <input type="hidden" name="ProductId" value="@Model.Id" />

                                    <div class="form-group">
                                        <div class="rate">
                                            <input type="radio" id="star5" name="Rating" value="5" checked />
                                            <label for="star5" title="5 stars">5 stars</label>
                                            <input type="radio" id="star4" name="Rating" value="4" />
                                            <label for="star4" title="4 stars">4 stars</label>
                                            <input type="radio" id="star3" name="Rating" value="3" />
                                            <label for="star3" title="3 stars">3 stars</label>
                                            <input type="radio" id="star2" name="Rating" value="2" />
                                            <label for="star2" title="2 stars">2 stars</label>
                                            <input type="radio" id="star1" name="Rating" value="1" />
                                            <label for="star1" title="1 star">1 star</label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Nhận xét (Tùy chọn):</label>
                                        <textarea name="Comment" class="form-control" rows="4" placeholder="Chia sẻ cảm nhận của bạn về chiếc bánh này..."></textarea>
                                    </div>

                                    <button type="submit" class="btn-submit-review">Gửi đánh giá</button>
                                </form>
                            }
                            else
                            {
                                <p>Vui lòng <a href="/User/Login?returnUrl=/Product/Details/@Model.Id" style="color: @mainColor; font-weight: bold;">Đăng nhập</a> để viết đánh giá.</p>
                            }
                        </div>

                    </div>

                    <div id="shipping" class="tab-pane">
                        <p>Freeship cho đơn hàng trên 300.000đ.</p>
                    </div>
                </div>
            </div>

            @if (relatedProducts != null && relatedProducts.Any())
            {
                <div class="related-products fade-up delay-3">
                    <h2 class="section-title">Có thể bạn sẽ thích</h2>
                    <div class="product-grid">
                        @foreach (var item in relatedProducts)
                        {
                            var rImg = item.ProductImages?.FirstOrDefault()?.ImageUrl ?? "/assets/images/no-image.png";
                            <div class="product-card" data-category="@item.CategoryId">
                                <div class="card-img-wrapper">
                                    <img src="@rImg" alt="@item.Name">
                                    <div class="overlay-actions">
                                        <a href="@Url.Action("Details", "Product", new { id = item.Id })" class="btn-quick-view"><i class="fa-regular fa-eye"></i></a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h3 class="product-name">@item.Name</h3>
                                    <div class="price-row">
                                        <span class="price">@item.Price.ToString("N0") đ</span>
                                        <div>
                                            <button type="button" class="btn-add-cart add-to-cart-btn" data-id="@item.Id" title="Thêm vào giỏ">
                                                <i class="fa-solid fa-cart-plus"></i>
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

        </div>
    </div>
</section>

@section Scripts {
    <script>
        var swiperIntro = new Swiper(".introSwiper", {
            spaceBetween: 0, centeredSlides: true, autoplay: { delay: 3500, disableOnInteraction: false }, speed: 3000, loop: true
        });

        document.addEventListener("DOMContentLoaded", function() {
            // Hiệu ứng chữ nhảy
            const textElement = document.querySelector('.title-cheese');
            if(textElement) {
                const textContent = textElement.innerText;
                textElement.innerHTML = '';
                let accumulatedDelay = 1.5;
                textContent.split('').forEach((char) => {
                    const span = document.createElement('span');
                    if (char === ' ') {
                        span.innerHTML = '&nbsp;'; accumulatedDelay += 0.5;
                    } else {
                        span.innerText = char;
                        span.style.animationDelay = accumulatedDelay + 's';
                        accumulatedDelay += (Math.random() * 0.4) + 0.2;
                    }
                    textElement.appendChild(span);
                });
            }

            // Logic tăng giảm số lượng
            const qtyInput = document.querySelector('.qty-input');
            if(qtyInput) {
                const minusBtn = document.querySelector('.qty-btn.minus');
                const plusBtn = document.querySelector('.qty-btn.plus');
                const maxStock = parseInt(qtyInput.getAttribute('max'));
                minusBtn.addEventListener('click', () => {
                    let val = parseInt(qtyInput.value);
                    if (val > 1) qtyInput.value = val - 1;
                });
                plusBtn.addEventListener('click', () => {
                    let val = parseInt(qtyInput.value);
                    if (val < maxStock) qtyInput.value = val + 1;
                });
            }
            // --- CODE MỚI: AJAX ADD TO CART ---
            const btnAdd = document.getElementById('btnAddToCart');
            if(btnAdd) {
                btnAdd.addEventListener('click', function() {
                    const pId = document.getElementById('productId').value;
                    const qty = document.getElementById('quantity').value;

                    // Hiệu ứng loading
                    const originalContent = btnAdd.innerHTML;
                    btnAdd.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';
                    btnAdd.disabled = true;

                    // Gọi AJAX (Sử dụng Fetch API hoặc jQuery $.ajax đều được, ở đây dùng jQuery cho ngắn gọn nếu project đã có)
                    // Nếu chưa có jQuery, đây là cách dùng Fetch API chuẩn JS thuần:

                    const formData = new FormData();
                    formData.append('productId', pId);
                    formData.append('quantity', qty);

                    fetch('/Cart/AddToCart', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Trả lại trạng thái nút
                        btnAdd.innerHTML = originalContent;
                        btnAdd.disabled = false;

                        if(data.success) {
                            updateCartBadge();
                            // Cập nhật số lượng trên icon giỏ hàng (nếu có class .cart-badge)
                            const cartBadge = document.querySelector('.cart-badge');
                            if(cartBadge && data.cartCount) cartBadge.innerText = data.cartCount;

                            // Thông báo thành công (Toast góc phải)
                            Swal.fire({
                                icon: 'success',
                                title: 'Thêm thành công!',
                                text: data.message,
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                background: '#FCF5EF',
                                color: '#4B3022'
                            });
                        } else if(data.requireLogin) {
                            // Yêu cầu đăng nhập
                            Swal.fire({
                                title: 'Bạn chưa đăng nhập',
                                text: "Vui lòng đăng nhập để mua hàng!",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '@mainColor',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Đăng nhập ngay',
                                cancelButtonText: 'Để sau'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '/User/Login?returnUrl=' + window.location.pathname;
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: data.message,
                                confirmButtonColor: '@mainColor'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        btnAdd.innerHTML = originalContent;
                        btnAdd.disabled = false;
                        Swal.fire('Lỗi', 'Không thể kết nối đến server.', 'error');
                    });
                });
            }
            // Sự kiện click nút thêm giỏ hàng
            $('.add-to-cart-btn').click(function () {
                var productId = $(this).data('id');
                var btn = $(this);

                // Hiệu ứng loading nhỏ trên nút
                var originalIcon = btn.html();
                btn.html('<i class="fa-solid fa-spinner fa-spin"></i>').prop('disabled', true);

                $.ajax({
                    url: '/Cart/AddToCart',
                    type: 'POST',
                    data: { productId: productId, quantity: 1 },
                    success: function (response) {
                        btn.html(originalIcon).prop('disabled', false);

                        if (response.success) {
                            // Cập nhật badge số lượng trên header
                            $('.cart-badge').text(response.cartCount).show();

                            // Thông báo thành công đẹp
                            Swal.fire({
                                icon: 'success',
                                title: 'Thêm thành công!',
                                text: response.message,
                                showConfirmButton: false,
                                timer: 1500,
                                toast: true,
                                position: 'top-end',
                                background: '#FCF5EF',
                                color: '#4B3022'
                            });
                        } else if (response.requireLogin) {
                            // Yêu cầu đăng nhập
                            Swal.fire({
                                icon: 'warning',
                                title: 'Bạn chưa đăng nhập',
                                text: 'Vui lòng đăng nhập để mua bánh nhé!',
                                confirmButtonText: 'Đăng nhập ngay',
                                confirmButtonColor: '#4B3022'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '/User/Login?returnUrl=' + window.location.pathname;
                                }
                            });
                        } else {
                            Swal.fire('Lỗi', response.message, 'error');
                        }
                    },
                    error: function () {
                        btn.html(originalIcon).prop('disabled', false);
                        Swal.fire('Lỗi', 'Không thể kết nối đến server.', 'error');
                    }
                });
            });
            // Animation scroll
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) entry.target.classList.add('active');
                });
            });
            document.querySelectorAll('.fade-up').forEach((el) => observer.observe(el));
        });
        $(document).ready(function() {
            $('#reviewForm').on('submit', function(e) {
                e.preventDefault(); // Ngăn reload trang

                var formData = $(this).serialize();
                var btn = $('.btn-submit-review');
                var originalText = btn.text();

                // Hiệu ứng loading
                btn.html('<i class="fa-solid fa-spinner fa-spin"></i> Đang gửi...').prop('disabled', true);

                $.ajax({
                    url: '/Review/AddReview',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        btn.html(originalText).prop('disabled', false);

                        if (response.success) {
                            // Thông báo thành công
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: response.message,
                                confirmButtonColor: '@mainColor'
                            }).then(() => {
                                // Reload trang sau khi bấm OK để hiện review mới
                                window.location.reload();
                            });

                            // Xóa form
                            $('#reviewForm')[0].reset();
                            updateCartBadge();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: response.message,
                                confirmButtonColor: '@mainColor'
                            });
                        }
                    },
                    error: function() {
                        btn.html(originalText).prop('disabled', false);
                        Swal.fire('Lỗi', 'Không thể kết nối đến server.', 'error');
                    }
                });
            });
        
            
        });
        // Chuyển Tab
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-pane");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            // Thêm timeout nhỏ để CSS animation kịp chạy
            setTimeout(() => {
                 document.getElementById(tabName).classList.add("active");
            }, 10);
            evt.currentTarget.classList.add("active");
        }

        // Swiper Gallery
        var swiperThumbs = new Swiper(".gallery-thumbs", {
            spaceBetween: 10, slidesPerView: 4, freeMode: true, watchSlidesProgress: true,
        });
        var swiperMain = new Swiper(".gallery-main", {
            spaceBetween: 10,
            navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev", },
            thumbs: { swiper: swiperThumbs, },
        });
    </script>
}