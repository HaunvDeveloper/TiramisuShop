@using TiramisuShop.Models
@{
    ViewData["Title"] = "Menu";

    // Lấy dữ liệu từ ViewBag
    var categories = ViewBag.Categories as List<Category>;
    var products = ViewBag.Products as List<Product>;
}

@section Links {
    <link rel="stylesheet" href="~/css/product-index.css">
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Kanit:wght@300;400;500;600&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
}

<section id="content" style="background: #FCF5EF;">
    <div id="intro-picture">
        <div class="swiper mySwiper introSwiper">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><img src="~/assets/images/Home.png" alt="Cheese Cheese Banner"></div>
            </div>
        </div>
        <h2 class="title-cheese">CHEESE CHEESE</h2>
        <h5 class="subtitle-cheese">Thực đơn ngọt ngào</h5>
    </div>

    <div class="section-menu">
        <div class="container">

            <div class="menu-header fade-up">
                <h2 class="menu-title">Danh sách bánh</h2>
                <p class="menu-desc">Những chiếc Tiramisu tươi ngon nhất được làm mới mỗi ngày.</p>
                <img src="~/assets/images/divider-wheat.png" class="divider-img" alt="">
            </div>

            <div class="menu-tabs fade-up delay-2">
                <button class="tab-btn active" data-filter="all">Tất cả</button>

                @if (categories != null)
                {
                    foreach (var cat in categories)
                    {
                        <button class="tab-btn" data-filter="@cat.Id">@cat.Name</button>
                    }
                }
            </div>

            <div class="product-grid fade-up delay-3">

                @if (products != null && products.Any())
                {
                    foreach (var item in products)
                    {
                        // 1. Xử lý Ảnh: Lấy ảnh đầu tiên hoặc ảnh placeholder
                        // Lưu ý: Kiểm tra lại tên thuộc tính trong Model là ImageUrl hay ImageURL
                        var firstImage = item.ProductImages?.FirstOrDefault()?.ImageUrl ?? "/assets/images/no-image.png";

                        // 2. Xử lý Màu sắc: Nếu HexColor null thì dùng màu nâu mặc định
                        var nameColor = !string.IsNullOrEmpty(item.HexColor) ? item.HexColor : "#4B3022";

                        // 3. Xử lý Logic Badge
                        bool isSale = item.EventId != null;

                        <div class="product-card" data-category="@item.CategoryId">

                            @if (isSale)
                            {
                                <div class="card-badge" style="background: #ff6b81; color: white;">Sale</div>
                            }
                            else if (item.IsHot)
                            {
                                <div class="card-badge" style="background: #FFD700; color: #4B3022;">Best Seller</div>
                            }
                            else if (item.Stock < 5)
                            {
                                <div class="card-badge" style="background: #95a5a6; color: white;">Limited</div>
                            }

                            <div class="card-img-wrapper">
                                <img src="@firstImage" alt="@item.Name">

                                <div class="overlay-actions">
                                    <a href="@Url.Action("Details", "Product", new { id = item.Id })" class="btn-quick-view" title="Xem chi tiết">
                                        <i class="fa-regular fa-eye"></i>
                                    </a>
                                </div>
                            </div>

                            <div class="card-body">
                                <h3 class="product-name" style="color: @nameColor;">@item.Name</h3>

                                <p class="product-desc">@item.Description</p>

                                <div class="price-row">
                                    <span class="price">@item.Price.ToString("N0") đ</span>

                                    <form asp-controller="Cart" asp-action="AddToCart" method="post">
                                        <input type="hidden" name="productId" value="@item.Id" />
                                        <button type="submit" class="btn-add-cart" title="Thêm vào giỏ">
                                            <i class="fa-solid fa-cart-plus"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center">
                        <p style="font-family: 'Kanit'; font-size: 1.2rem; color: #666;">Hiện chưa có sản phẩm nào.</p>
                    </div>
                }

            </div>

            <div class="text-center mt-5 fade-up delay-3">
                <a href="#" class="btn-view-more">Xem thêm các loại bánh khác</a>
            </div>

        </div>
    </div>
</section>

@section Scripts {
    <script>
        // --- 1. SCRIPT SWIPER HERO ---
        var swiper = new Swiper(".introSwiper", {
            spaceBetween: 0,
            centeredSlides: true,
            autoplay: { delay: 3500, disableOnInteraction: false },
            speed: 3000,
            loop: true
        });

        // --- 2. SCRIPT TÁCH CHỮ (Hiệu ứng nhảy) ---
        document.addEventListener("DOMContentLoaded", function () {
            const textElement = document.querySelector('.title-cheese');
            if (textElement) {
                const textContent = textElement.innerText;
                textElement.innerHTML = '';
                let accumulatedDelay = 1.5;
                textContent.split('').forEach((char) => {
                    const span = document.createElement('span');
                    if (char === ' ') {
                        span.innerHTML = '&nbsp;';
                        accumulatedDelay += 0.5;
                    } else {
                        span.innerText = char;
                        span.style.animationDelay = accumulatedDelay + 's';
                        accumulatedDelay += (Math.random() * 0.4) + 0.2;
                    }
                    textElement.appendChild(span);
                });
            }

            // --- 3. SCRIPT SCROLL ANIMATION (Fade Up) ---
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-up').forEach((el) => observer.observe(el));

            // --- 4. SCRIPT LỌC SẢN PHẨM (FILTER) ---
            const filterBtns = document.querySelectorAll('.tab-btn');
            const products = document.querySelectorAll('.product-card');

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Xử lý class active cho nút
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filterValue = btn.getAttribute('data-filter');

                    // Hiệu ứng ẩn hiện sản phẩm
                    products.forEach(item => {
                        const itemCategory = item.getAttribute('data-category');

                        if (filterValue === 'all' || itemCategory === filterValue) {
                            item.style.display = 'block';
                            setTimeout(() => {
                                item.style.opacity = '1';
                                item.style.transform = 'scale(1)';
                            }, 50);
                        } else {
                            item.style.opacity = '0';
                            item.style.transform = 'scale(0.8)';
                            setTimeout(() => {
                                item.style.display = 'none';
                            }, 300);
                        }
                    });
                });
            });
        });
    </script>
}