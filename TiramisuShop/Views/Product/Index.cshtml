@using TiramisuShop.Models
@{
    ViewData["Title"] = "Menu";
    var categories = ViewBag.Categories as List<Category>;
    var products = ViewBag.Products as List<Product>;
    var now = DateTime.Now; // Lấy thời gian hiện tại để so sánh
}

@section Links {
    <link rel="stylesheet" href="~/css/product-index.css">
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Kanit:wght@300;400;500;600&family=Pacifico&display=swap" rel="stylesheet">
}

<section id="content" style="background: #FCF5EF;">
    <div id="intro-picture">
        <div class="swiper mySwiper introSwiper">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><img src="~/assets/images/Home.png" alt="Cheese Cheese Banner"></div>
            </div>
        </div>
        <h2 class="title-cheese">CHEESE CHEESE</h2>
        <h5 class="subtitle-cheese">Thực đơn ngọt ngào</h5>
    </div>

    <div class="section-menu">
        <div class="container">

            <div class="menu-header fade-up">
                <h2 class="menu-title">Danh sách bánh</h2>
                <p class="menu-desc">Những chiếc Tiramisu tươi ngon nhất được làm mới mỗi ngày.</p>
                <img src="~/assets/images/divider-wheat.png" class="divider-img" alt="">
            </div>

            <div class="menu-tabs fade-up delay-2">
                <button class="tab-btn active" data-filter="all">Tất cả</button>
                @if (categories != null)
                {
                    foreach (var cat in categories)
                    {
                        <button class="tab-btn" data-filter="@cat.Id">@cat.Name</button>
                    }
                }
            </div>

            <div class="product-grid fade-up delay-3">
                @if (products != null && products.Any())
                {
                    foreach (var item in products)
                    {
                        var firstImage = item.ProductImages?.FirstOrDefault()?.ImageUrl ?? "/assets/images/no-image.png";
                        var nameColor = !string.IsNullOrEmpty(item.HexColor) ? item.HexColor : "#4B3022";

                        // --- LOGIC TÍNH GIẢM GIÁ ---
                        bool hasDiscount = false;
                        decimal originalPrice = item.Price;
                        decimal finalPrice = item.Price;
                        double discountPercent = 0;

                        // Kiểm tra: Có Event ID + Event không null + Ngày hiện tại nằm trong khoảng diễn ra
                        if (item.EventId != null && item.Event != null && now >= item.Event.StartDate && now <= item.Event.EndDate)
                        {
                            hasDiscount = true;
                            discountPercent = item.Event.DiscountPercent;
                            // Tính giá sau giảm: Giá gốc * (100 - %)/100
                            finalPrice = item.Price * (decimal)((100 - discountPercent) / 100);
                        }

                        // --- KIỂM TRA HẾT HÀNG ---
                        bool isSoldOut = item.Stock <= 0;
                        string soldOutClass = isSoldOut ? "sold-out" : "";

                        <div class="product-card @soldOutClass" data-category="@item.CategoryId">

                            <div class="badges-wrapper" style="position: absolute; top: 15px; left: 15px; z-index: 5; display: flex; flex-direction: column; gap: 5px;">
                                @if (isSoldOut)
                                {
                                    <div class="card-badge" style="background: #7f8c8d; color: white;">Hết hàng</div>
                                }
                                else if (hasDiscount)
                                {
                                    // Hiện số % giảm cụ thể
                                    <div class="card-badge" style="background: #ff6b81; color: white;">-@discountPercent%</div>
                                }

                                @if (item.IsHot)
                                {
                                    <div class="card-badge" style="background: #FFD700; color: #4B3022;">Best Seller</div>
                                }
                            </div>

                            <div class="card-img-wrapper">
                                <img src="@firstImage" alt="@item.Name">
                                <div class="overlay-actions">
                                    <a href="@Url.Action("Details", "Product", new { id = item.Id })" class="btn-quick-view" title="Xem chi tiết">
                                        <i class="fa-regular fa-eye"></i>
                                    </a>
                                </div>
                            </div>

                            <div class="card-body">
                                <h3 class="product-name" style="color: @nameColor;">@item.Name</h3>
                                <p class="product-desc">@item.Description</p>

                                <div class="price-row" style="align-items: flex-end;">

                                    <div class="price-info">
                                        @if (hasDiscount)
                                        {
                                            <span class="old-price" style="text-decoration: line-through; color: #999; font-size: 0.9rem; display: block;">
                                                @originalPrice.ToString("N0") đ
                                            </span>
                                            <span class="price" style="color: #ff6b81;">
                                                @finalPrice.ToString("N0") đ
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="price">@originalPrice.ToString("N0") đ</span>
                                        }
                                    </div>

                                    @if (isSoldOut)
                                    {
                                        <button type="button" class="btn-add-cart disabled" disabled title="Hết hàng">
                                            <i class="fa-solid fa-ban"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn-add-cart add-to-cart-btn" data-id="@item.Id" title="Thêm vào giỏ">
                                            <i class="fa-solid fa-cart-plus"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center">
                        <p style="font-family: 'Kanit'; font-size: 1.2rem; color: #666;">Hiện chưa có sản phẩm nào.</p>
                    </div>
                }
            </div>
            <div class="text-center mt-5 fade-up delay-3">
                <a href="#" class="btn-view-more">Xem thêm các loại bánh khác</a>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        var swiper = new Swiper(".introSwiper", {
             spaceBetween: 0, centeredSlides: true, autoplay: { delay: 3500, disableOnInteraction: false }, speed: 3000, loop: true
         });

        document.addEventListener("DOMContentLoaded", function() {
            // Animation chữ
            const textElement = document.querySelector('.title-cheese');
            if(textElement) {
                const textContent = textElement.innerText; textElement.innerHTML = ''; let accumulatedDelay = 1.5;
                textContent.split('').forEach((char) => {
                    const span = document.createElement('span');
                    if (char === ' ') { span.innerHTML = '&nbsp;'; accumulatedDelay += 0.5; }
                    else { span.innerText = char; span.style.animationDelay = accumulatedDelay + 's'; accumulatedDelay += (Math.random() * 0.4) + 0.2; }
                    textElement.appendChild(span);
                });
            }

            // Scroll Animation
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => { if (entry.isIntersecting) entry.target.classList.add('active'); });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-up').forEach((el) => observer.observe(el));

            // Filter Logic
            const filterBtns = document.querySelectorAll('.tab-btn');
            const products = document.querySelectorAll('.product-card');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filterValue = btn.getAttribute('data-filter');
                    products.forEach(item => {
                        const itemCategory = item.getAttribute('data-category');
                        if (filterValue === 'all' || itemCategory === filterValue) {
                            item.style.display = 'flex';
                            setTimeout(() => { item.style.opacity = '1'; item.style.transform = 'scale(1)'; }, 50);
                        } else {
                            item.style.opacity = '0'; item.style.transform = 'scale(0.8)';
                            setTimeout(() => { item.style.display = 'none'; }, 300);
                        }
                    });
                });
            });
        });

        // --- AJAX ADD TO CART ---
        $(document).ready(function () {
            // Cập nhật số lượng giỏ hàng khi load trang
            updateCartBadge();

            // Sự kiện click nút thêm giỏ hàng
            $('.add-to-cart-btn').click(function () {
                var productId = $(this).data('id');
                var btn = $(this);

                // Hiệu ứng loading nhỏ trên nút
                var originalIcon = btn.html();
                btn.html('<i class="fa-solid fa-spinner fa-spin"></i>').prop('disabled', true);

                $.ajax({
                    url: '/Cart/AddToCart',
                    type: 'POST',
                    data: { productId: productId, quantity: 1 },
                    success: function (response) {
                        btn.html(originalIcon).prop('disabled', false);

                        if (response.success) {
                            // Cập nhật badge số lượng trên header
                            $('.cart-badge').text(response.cartCount).show();

                            // Thông báo thành công đẹp
                            Swal.fire({
                                icon: 'success',
                                title: 'Thêm thành công!',
                                text: response.message,
                                showConfirmButton: false,
                                timer: 1500,
                                toast: true,
                                position: 'top-end',
                                background: '#FCF5EF',
                                color: '#4B3022'
                            });
                            updateCartBadge();
                        } else if (response.requireLogin) {
                            // Yêu cầu đăng nhập
                            Swal.fire({
                                icon: 'warning',
                                title: 'Bạn chưa đăng nhập',
                                text: 'Vui lòng đăng nhập để mua bánh nhé!',
                                confirmButtonText: 'Đăng nhập ngay',
                                confirmButtonColor: '#4B3022'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '/User/Login?returnUrl=' + window.location.pathname;
                                }
                            });
                        } else {
                            Swal.fire('Lỗi', response.message, 'error');
                        }
                    },
                    error: function () {
                        btn.html(originalIcon).prop('disabled', false);
                        Swal.fire('Lỗi', 'Không thể kết nối đến server.', 'error');
                    }
                });
            });
        });
    </script>
}